<?php

include_once "util.php";
include_once "pagetpl.php";
include_once "dbconnect.php";

try {
    $db = dbConnect();

    $id = get_req_data("ifdbid");
    $newPath = get_req_data("path");
    $oldUrl = "https://ifdb.org/ifarchive-pending?ifdbid=$id";
    $apiKey = get_req_data("key");

    // remove any leading '/' in the path
    $newPath = preg_replace("/^\/+/", "", $newPath);

    // figure the new URL based on the relative path on the Archive
    $newUrl = "https://www.ifarchive.org/$newPath";

    if ($apiKey != localIfArchiveKey())
        throw new Exception("Error: invalid API key");

    $result = mysqli_execute_query($db,
        "select gameid from gamelinks
         where url = ?", [$oldUrl]);

    if (!$result) throw new Exception("Error: database gamelinks url query failed: " . mysqli_error($db));

    if (mysql_num_rows($result) == 0)
        throw new Exception("Error: no link found to this pending URL");

    $result = mysqli_execute_query($db,
        "update gamelinks
         set attrs = attrs & ~".GAMELINK_PENDING.", url=?
         where url=?", [$newUrl, $oldUrl]
    );
    
    if (!$result) throw new Exception("Error: database update failed: " . mysqli_error($db));

    header("Content-type: text/plain");
    echo "OK";
} catch (Exception $e) {
    error_log($e);
    http_response_code(500);
    header("Content-type: text/plain");
    echo $e->getMessage();
}

?>
