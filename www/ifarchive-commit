<?php

include_once "util.php";
include_once "pagetpl.php";
include_once "dbconnect.php";

try {
    $db = dbConnect();

    $id = mysql_real_escape_string(get_req_data("ifdbid"), $db);
    $newPath = mysql_real_escape_string(get_req_data("path"), $db);
    $oldUrl = "https://ifdb.org/ifarchive-pending?ifdbid=$id";
    $apiKey = get_req_data("key");

    // remove any leading '/' in the path
    $newPath = preg_replace("/^\/+/", "", $newPath);

    // figure the new URL based on the relative path on the Archive
    $newUrl = "https://www.ifarchive.org/$newPath";

    if ($apiKey != localIfArchiveKey())
        throw new Exception("Error: invalid API key");

    $result = mysql_query(
        "select gameid from gamelinks
        where url = '$oldUrl'", $db);

    if (mysql_num_rows($result) == 0)
        throw new Exception("Error: no link found to this pending URL");

    $result = mysql_query(
        "update gamelinks
        set attrs = attrs & ~".GAMELINK_PENDING.", url='$newUrl'
        where url='$oldUrl'", $db);
    
    if (!$result) throw new Exception("Error: database update failed: " . mysqli_error($db));

    header("Content-type: text/plain");
    echo "OK";
} catch (Exception $e) {
    error_log($e);
    http_response_code(500);
    header("Content-type: text/plain");
    echo $e->getMessage();
}

?>
